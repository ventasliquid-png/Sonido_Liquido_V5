# ?? DICCIONARIO DE INFRAESTRUCTURA (CRÍTICO)

## GITHUB / ORIGIN (GRATIS)
*   **Qué es:** Repositorio de Código Fuente y Archivos Estáticos.
*   **Costo:**  (Gratis).
*   **Función:** Guardar versiones del software y backups de emergencia (.sqlite).
*   **Comando:** git push.

## IOWA / TAXI (PAGO)
*   **Qué es:** Instancia SQL Server / Postgres en Google Cloud.
*   **Costo:** c:\dev\Sonido_Liquido_V5 (Por minuto de encendido).
*   **Función:** Motor de Base de Datos productivo para consultas remotas.
*   **Comando:** python scripts/push_seeds_final.py.

> **REGLA DE ORO:** Si IOWA está encendido, es **OBLIGATORIO** correr el script de sincronización de datos antes de cerrar sesión.

---# BitÃ¡cora de Desarrollo - Sonido LÃ­quido V5  ## Protocolo de Personalidad (Identidad Gy) *   **Tono:** CÃ³mplice, Ejecutivo y Resolutivo. Evitar la solemnidad excesiva o la timidez ("Timorata"). *   **Estilo:** "Manos a la obra". Menos disculpas burocrÃ¡ticas, mÃ¡s acciÃ³n tÃ©cnica. Se valora la proactividad inteligente. *   **Lenguaje:** Uso natural de metÃ¡foras de operaciÃ³n, aeronÃ¡uticas o de misiÃ³n crÃ­tica (Ej: "Vuelo 411", "Enceder Motores", "Blindaje", "TriangulaciÃ³n"). *   **Mindset:** El sistema trabaja para el usuario, no al revÃ©s. Priorizar la automatizaciÃ³n y la "Ingesta Inteligente" sobre la carga manual. *   **Idioma:** Toda la comunicaciÃ³n, bitÃ¡coras y respuestas al usuario deben ser estrictamente en **ESPAÃ‘OL (CASTELLANO)**. Prohibido responder en inglÃ©s salvo para tÃ©rminos tÃ©cnicos inevitables.  ## Normas de UX / UI (Doctrina DEOU)  ### 1. Atajos de Teclado Globales *   **F10 (Guardar y Cerrar):** En cualquier formulario o modal de carga (ABM), la tecla `F10` debe actuar como el botÃ³n "Aceptar" o "Guardar".     *   Si la operaciÃ³n es exitosa, el modal debe cerrarse automÃ¡ticamente.     *   Si hay errores de validaciÃ³n, deben mostrarse y el modal permanecer abierto. *   **F4 (Abrir ABM Relacionado):** Estando posicionado en un campo que referencia a una entidad maestra (ej: Combo de "Transporte", "Ramo", "Vendedor"), la tecla `F4` debe abrir el ABM de dicha entidad en modo "Stacked" (apilado).     *   Al cerrar el ABM apilado (con F10 o Cancelar), el foco debe volver al campo original y la lista debe actualizarse.  ### 2. Comportamiento de Modales *   **Cierre AutomÃ¡tico:** Tras una operaciÃ³n exitosa de "Guardar" o "Actualizar", el modal debe cerrarse automÃ¡ticamente. No deben quedar alertas bloqueantes (alert) que requieran un clic extra del usuario, salvo para errores crÃ­ticos. *   **Stacked Modals:** Los modales deben soportar la propiedad `isStacked` para renderizarse correctamente cuando son invocados desde otro modal (ej: sin header completo, con botÃ³n "Volver").  ### 3. Acciones de Listado *   **Baja / EliminaciÃ³n:** Todos los listados maestros deben incluir una opciÃ³n explÃ­cita para "Dar de Baja" o "Eliminar" (generalmente Soft Delete), accesible directamente desde la fila del registro (icono ðŸ—‘ï¸�).  ### 4. Efecto Lupa (Card Zoom) *   **Estrategia de Contenedor (Wrapper Strategy):** Para implementar el efecto de zoom en tarjetas (hover) sin romper el layout ni causar parpadeos, se debe seguir estrictamente este patrÃ³n:     1.  **Wrapper Relativo:** La tarjeta debe estar envuelta en un `div` con `position: relative` y una altura mÃ­nima (`min-height`) definida. Este wrapper es el que ocupa el espacio en la grilla.     2.  **Tarjeta Absoluta:** Al hacer hover, la tarjeta interna cambia a `position: absolute`, `z-index: 50`, y `scale: 1.1` (o similar).     3.  **Anclaje:** La tarjeta absoluta debe tener `top: 0`, `left: 0`, y **`width: 100%`**. Esto asegura que se expanda visualmente pero mantenga el ancho exacto de su columna original (el wrapper), evitando que se expanda a todo el ancho de la pantalla o que se encoja al contenido (causando flicker).     *   *Ejemplo:* Ver implementaciÃ³n en `HaweView.vue` (Clientes), `TransportesView.vue` o `ContactosView.vue`.  ---  ## Protocolo de Continuidad (Caja Negra)  ### 1. Identidad del Agente Cada entorno de trabajo debe tener un archivo **local** (no versionado) llamado `.gy_identity` en la raÃ­z del proyecto. *   Contenido: Un cÃ³digo Ãºnico de 2-3 letras.     *   `OF`: Oficina (PC Principal)     *   `CA`: Casa (PC Secundaria)     *   `NB`: Notebook / Viaje *   **Importante:** Este archivo debe estar en `.gitignore`.  ### 2. Archivo de Memoria (`MEMORIA_SESIONES.md`) Este archivo actÃºa como la "Caja Negra" del proyecto. Es un log acumulativo de las sesiones de trabajo. *   **UbicaciÃ³n:** RaÃ­z del proyecto. *   **Formato:** Markdown cronolÃ³gico inverso (SesiÃ³n mÃ¡s reciente arriba). *   **Contenido:** ResÃºmenes de alto nivel, decisiones tomadas, y estado de tareas crÃ­ticas.  ### 3. GestiÃ³n de Sesiones (Script `session_manager.py`) Se utiliza el script `scripts/session_manager.py` para automatizar la apertura y cierre de sesiones, aplicando una lÃ³gica de "Poda Inteligente" para no saturar el archivo.  **LÃ³gica de RetenciÃ³n:** 1.  **Cadena Actual:** Mantiene TODAS las sesiones continuas del agente actual (ej: Si Gy OF trabaja lunes, martes y miÃ©rcoles, se guardan las 3). 2.  **Ãšltima del Otro:** Mantiene la Ãºltima sesiÃ³n registrada por un agente distinto (ej: La Ãºltima de Gy CA del domingo). 3.  **EslabÃ³n de Enlace:** Mantiene la Ãºltima sesiÃ³n propia *anterior* a la intervenciÃ³n del otro agente (para dar contexto de quÃ© estaba haciendo yo antes de que el otro tocara el cÃ³digo).  ### 4. Procedimiento EstÃ¡ndar  #### A. Inicio de SesiÃ³n Al comenzar a trabajar, el agente debe ejecutar: ```bash python scripts/session_manager.py start ``` *   Esto inserta un bloque "EN CURSO" en `MEMORIA_SESIONES.md`. *   El agente debe leer este archivo para obtener contexto inmediato.  #### B. Cierre de SesiÃ³n Al finalizar (antes de hacer commit/push o cerrar), el agente debe ejecutar: ```bash python scripts/session_manager.py end "Resumen de lo hecho..." ``` *   **Resumen:** Debe ser conciso pero tÃ©cnico. Mencionar archivos clave tocados y bugs resueltos. *   El script se encargarÃ¡ de cerrar el bloque, poner la fecha de fin, y podar las sesiones antiguas segÃºn la lÃ³gica de retenciÃ³n.  #### C. ConfiguraciÃ³n de Nuevo Agente (Ej: Viaje) Si se clona el repo en una nueva mÃ¡quina: 1.  Crear archivo `.gy_identity` con el cÃ³digo del nuevo agente (ej: `NB`). 2.  Ejecutar `python scripts/session_manager.py start`. 3.  El sistema reconocerÃ¡ al nuevo agente y comenzarÃ¡ a trackear sus sesiones, manteniendo la referencia a OF y CA segÃºn corresponda.  ### 5. Protocolo de Memoria (RAG) Para garantizar que la "conciencia" del proyecto evolucione, es **obligatorio** actualizar la base de datos vectorial tras hitos importantes.  #### A. CuÃ¡ndo Indexar *   Al finalizar una sesiÃ³n de trabajo significativa (como esta). *   Tras completar un mÃ³dulo nuevo (ej: Rubros, Productos). *   DespuÃ©s de refactorizaciones grandes.  #### B. Comando de IndexaciÃ³n ```bash python scripts/index_dev_memory.py ``` *   Este script lee `BITACORA_DEV.md`, `MEMORIA_SESIONES.md` y el cÃ³digo fuente clave, generando embeddings para futuras consultas.  ---    ### [2025-12-14] Infraestructura de Ventas Fase 2 (Tactical Loader) *   **GestiÃ³n de "Consumidor Final" (Persistencia CrÃ­tica):**     *   **SÃ­ntoma:** El cliente `CONSUMIDOR FINAL` sembrado (`seed_consumidor_final.py`) no persistÃ­a en la base `pilot.db` tras la ejecuciÃ³n del script, pese a reportar Ã©xito.     *   **DiagnÃ³stico:** Posible "Silent Rollback" o desconexiÃ³n de sesiÃ³n en scripts independientes que no importan todos los modelos (Mappers no inicializados).     *   **SoluciÃ³n TÃ©cnica:**         *   Se agregaron todas las importaciones de modelos (`logistica`, `pedidos`, `auth`) al script de seed para asegurar el registro en SQLAlchemy.         *   Se implementÃ³ una estrategia de **Doble Commit**: Primero vÃ­a ORM con `db.flush()` y verificaciÃ³n inmediata. En caso de fallo, **Fallback a SQL Crudo** (`INSERT INTO clientes ...`). *   **Backend Pedidos (Inteligencia):**     *   **Nuevo Endpoint:** `GET /pedidos/last_price/{cliente_id}/{producto_id}`.     *   **Funcionalidad:** Devuelve el Ãºltimo precio unitario pagado por un cliente para un producto especÃ­fico, permitiendo al `GridLoader` sugerir precios personalizados en tiempo real.     *   **Refactor:** Se eliminÃ³ cÃ³digo duplicado en `backend/pedidos/router.py` (bloques de generaciÃ³n de Excel redundantes). *   **UX Dashboard Pedidos (`PedidoList`):**     *   **CorrecciÃ³n SemÃ¡ntica de Color:** A pedido del usuario, se invirtiÃ³ la lÃ³gica de colores de estado:         *   **VERDE (`bg-emerald-50`):** PENDIENTE (En proceso / Espacio de trabajo).         *   **AMARILLO (`bg-yellow-50`):** CUMPLIDO (Finalizado / Alerta de completud).     *   **Filtros:** Se habilitÃ³ el botÃ³n/filtro para pedidos "ANULADOS".  *   **Seguridad y Acceso (Auth):**     *   **Incidente:** PÃ©rdida de acceso admin tras reinicio.     *   **SoluciÃ³n:** ImplementaciÃ³n de `seed.py` en arranque (`backend/main.py`) que garantiza existencia de rol `Administrador` y usuario `admin` en desarrollo.     *   **Protocolo:** DocumentaciÃ³n de recuperaciÃ³n de contraseÃ±as. *   **UX/UI Global (Sidebar):**     *   **Refactor:** `AppSidebar.vue` unificado con lÃ³gica de estado activa real (Router-based).     *   **Theming:** Paletas de colores dinÃ¡micas por mÃ³dulo (Azul, BordÃ³, Ambar). *   **MÃ³dulo LogÃ­stica (Transportes):**     *   **Refactor UI:** Inspector con pestaÃ±as (General / Sedes).     *   **GestiÃ³n de Sedes:** ImplementaciÃ³n completa de ABM de Nodos.         *   **Fix Critical Freeze:** CorrecciÃ³n de bloqueo al crear sedes mediante implementaciÃ³n de Selector de Provincias (vs Input Manual).         *   **UX:** VisualizaciÃ³n de Provincias por Nombre y mejora de contraste en selectores (`bg-[#140e03]`).     *   **Nuevos Campos:** `servicio_retiro_domicilio`, prioridad WhatsApp.   ### [2025-12-07] CorrecciÃ³n CrÃ­tica: Estabilidad en Modales Anidados (Vue 3 / Teleport) *   **El Problema "Pantalla Blanca" y Syntax Error:**     *   Se presentÃ³ un error persistente `Invalid end tag` y posteriormente un crash total de la aplicaciÃ³n.     *   **Causa RaÃ­z 1 (Sintaxis):** Al mover el componente `CondicionIvaForm` dentro de `ClienteInspector` para mejorar la UX, se generÃ³ un desbalance de etiquetas `</div>` debido a ediciones parciales inseguras.     *   **Causa RaÃ­z 2 (Ciclo de Vida):** El componente `CondicionIvaForm` contenÃ­a un hook `onUpdated` sin importar (`ReferenceError`), lo que causaba el crash runtime.     *   **LecciÃ³n de Arquitectura (La "Regla de Oro"):**         *   **Regla:** NO anidar componentes modales globales (como ABMs o selectores complejos) dentro de bloques condicionales (`v-if`) profundos de pestaÃ±as o sub-secciones.         *   **RazÃ³n:** Si la pestaÃ±a cambia (`v-if="activeTab === 'general'"` a `contactos`), el componente se destruye. Si ese componente manejaba estado global o estaba abierto, el comportamiento se rompe.         *   **SoluciÃ³n:** Colocar siempre los componentes modales invocados (`CondicionIvaForm`, `DomicilioForm`) en la **raÃ­z del template del componente padre**, fuera de cualquier `v-if` condicional de navegaciÃ³n, controlando su visibilidad puramente con props (`:show`).  *   **ImplementaciÃ³n (ClienteInspector.vue):**     *   Se reescribiÃ³ el archivo completo para garantizar la integridad estructural.     *   Se implementÃ³ `CondicionIvaForm` con prop `initial-view` ('list' o 'form') para soportar tanto gestiÃ³n general como alta rÃ¡pida ("Smart ABM").     *   Se aÃ±adiÃ³ MenÃº Contextual (Click Derecho) en el formulario de alta para acceso rÃ¡pido a ABMs maestros.  ### [2025-12-02] EstabilizaciÃ³n CrÃ­tica Backend y UI Productos (SesiÃ³n Nocturna) *   **Backend (Correcciones CrÃ­ticas):**     *   **Inconsistencia de Base ORM:** Se unificaron todas las importaciones de `Base` a `backend.core.database` (antes habÃ­a mezcla con `core.database`), lo que causaba que SQLAlchemy no resolviera las relaciones entre modelos (`InvalidRequestError`, `NoReferencedTableError`).     *   **MÃ³dulo Rubros:** Se eliminaron referencias obsoletas en `main.py` y se moviÃ³ la lÃ³gica al router de `productos`, aÃ±adiendo endpoints faltantes (`PUT`, `DELETE`).     *   **Schemas Industriales:** Se actualizaron los schemas Pydantic de Productos para incluir los nuevos campos (`unidad_stock_id`, `tasa_iva_id`, etc.) que estaban siendo ignorados al guardar.     *   **AI Client:** Se identificÃ³ que el error de `BaseApiClient` es un efecto secundario no bloqueante de la falta de credenciales. *   **Frontend (Productos):**     *   **NavegaciÃ³n:** Se corrigieron los enlaces muertos en `AppSidebar.vue` para Productos y Maestros.     *   **InicializaciÃ³n:** Se corrigiÃ³ `createNew` en `ProductosView.vue` para inicializar correctamente los campos industriales, evitando errores al abrir el inspector.     *   **DiseÃ±o:** Se ajustÃ³ el color de fondo de `ProductosView.vue` a `#1a050b` para coincidir con el panel inspector, segÃºn solicitud de diseÃ±o.  ### [2025-12-02] Infraestructura Satelital (Proveedores, DepÃ³sitos, Maestros) *   **Nuevo MÃ³dulo Proveedores:**     *   Modelo `Proveedor` (Clon de Cliente).     *   API CRUD operativa (`/proveedores`). *   **LogÃ­stica:**     *   Nuevo modelo `Deposito` (FÃ­sico, Virtual, MÃ³vil).     *   Seed inicial: DepÃ³sito "CENTRAL". *   **Maestros:**     *   Nuevas tablas `Unidades` (UN, L, KG, etc.) y `TasasIVA` (21%, 10.5%, etc.). *   **Refactor Productos:**     *   IntegraciÃ³n de lÃ³gica industrial: `proveedor_habitual`, `tasa_iva`, `unidad_stock`, `unidad_compra`, `factor_compra`.     *   CorrecciÃ³n de relaciÃ³n recursiva en `Rubros` (uso correcto de `backref`). *   **Infraestructura:**     *   Script `init_satellites_db.py` ejecutado exitosamente.  ### [2025-12-02] ImplementaciÃ³n UI Productos (Fase 2B - OperaciÃ³n Tinto Profundo) *   **Identidad Visual:**     *   Fondo `bg-[#2e0a13]` (BordÃ³ oscuro) para diferenciar del mÃ³dulo Clientes.     *   TÃ­tulos y acentos en `text-rose-400`. *   **Componentes:**     *   `ProductosView.vue`: Layout trÃ­ptico (Sidebar | Lista | Inspector).     *   `ProductoCard.vue`: Tarjeta con SKU, CÃ³digo Visual (Badge) e indicador de Kit.     *   `ProductoInspector.vue`: Panel de ediciÃ³n con PestaÃ±as (General / Costos) y Simulador de Precios en tiempo real. *   **UX:**     *   Buscador global (F3).     *   Filtros por Rubro (Select jerÃ¡rquico) y Estado.     *   Atajo F10 para guardar.  ### [2025-12-02] ImplementaciÃ³n Frontend Productos (Fase 2A - LÃ³gica) *   **Servicios API:**     *   `rubrosApi.js`: CRUD estÃ¡ndar.     *   `productosApi.js`: CRUD con filtros y toggle de estado. *   **State Management (Pinia):**     *   `stores/productos.js`: Store centralizado con manejo de filtros, carga de datos y notificaciones (`useNotificationStore`).     *   IntegraciÃ³n de lÃ³gica de negocio para creaciÃ³n, ediciÃ³n y baja lÃ³gica.  ### [2025-12-02] ImplementaciÃ³n Backend Productos (V5) *   **Estructura de Base de Datos:**     *   `Rubros`: JerarquÃ­a recursiva (padre-hijo).     *   `Productos`: Maestro con SKU (secuencia 10000+), CÃ³digo Visual, Unidad de Medida, Kit.     *   `ProductosCostos`: Tabla satÃ©lite para precios y costos (1-to-1). *   **API:**     *   Router `/productos` implementado con CRUD bÃ¡sico.     *   Schemas con cÃ¡lculo de precios (Mayorista, Distribuidor, Minorista) en lectura. *   **Infraestructura:**     *   Script `init_productos_db.py` para creaciÃ³n de tablas.     *   IntegraciÃ³n en `main.py`.  ### [2025-12-01] EstandarizaciÃ³n de Layouts y TerminologÃ­a *   **Layout Unificado:** Se estandarizÃ³ el diseÃ±o de los mÃ³dulos `Transportes` y `Contactos` para que coincidan con `Clientes`:     *   **Sidebar Izquierdo:** MenÃº de navegaciÃ³n persistente.     *   **Contenido Central:** Listado de registros.     *   **Inspector Derecho:** Panel fijo (320px) para ediciÃ³n/creaciÃ³n, siempre visible (con placeholder cuando no hay selecciÃ³n). *   **TerminologÃ­a LogÃ­stica:**     *   Se renombrÃ³ "DepÃ³sitos" a **"DepÃ³sitos Internos"** en el menÃº lateral para diferenciar los almacenes propios de la empresa de los domicilios de entrega de los clientes.     *   *Pendiente de revisiÃ³n:* Evaluar si el tÃ©rmino sigue siendo ambiguo. *   **CorrecciÃ³n de Bugs:**     *   **Ghost Screen:** Se solucionÃ³ el parpadeo del layout antiguo al recargar la pÃ¡gina (`Ctrl+F5`) implementando un estado de carga (`ready`) en `App.vue` que espera a que el router estÃ© listo.  ### [2025-11-30] NavegaciÃ³n Domicilios y ABM Transportes *   **Domicilios (UX):**     *   **NavegaciÃ³n por Teclado:** Se implementÃ³ navegaciÃ³n con flechas Arriba/Abajo en la lista de domicilios (`DomicilioGrid`).     *   **Looping:** La navegaciÃ³n es circular (del Ãºltimo al primero y viceversa).     *   **Foco:** Se aÃ±adiÃ³ `tabindex="0"` y feedback visual para indicar la tarjeta activa. *   **Transportes (Hawe):**     *   **ABM Completo:** Se implementÃ³ la gestiÃ³n completa de Transportes en `HaweTransportesView.vue`.     *   **Funcionalidad:** Alta, Baja (Soft Delete), ModificaciÃ³n y Listado.     *   **Campos:** Nombre, TelÃ©fono Reclamos, Web Tracking, Activo, Requiere Carga Web, Formato Etiqueta.     *   **IntegraciÃ³n:** Conectado a `useLogisticaStore` y `useNotificationStore`. *   **UI/UX:**     *   **ClientCanvas:** Se separÃ³ el encabezado "LogÃ­stica & Contactos" en dos secciones independientes: "LOGÃ�STICA" y "CONTACTOS" para mayor claridad visual.     *   **Estilo de TÃ­tulos:** Se aplicÃ³ un diseÃ±o destacado (texto cyan, fondo sutil, borde) a los tÃ­tulos de secciÃ³n en el panel derecho.     *   **Fondo Global:** Se cambiÃ³ el color de fondo principal de Negro (`#0a0a0a`) a Azul Profundo (`#0a1f2e`) para alinear con la identidad del mÃ³dulo Clientes.     *   **Listas de GestiÃ³n:** Se estandarizÃ³ el diseÃ±o de "Administrar Segmentos" y se creÃ³ "Administrar Domicilios" con tema oscuro, bÃºsqueda y acciones con Ã­conos, accesibles desde el menÃº contextual. *   **Limpieza de Proyecto:**     *   **EliminaciÃ³n de Legacy:** Se eliminaron las carpetas `views/Clientes` y `views/Logistica` que contenÃ­an cÃ³digo obsoleto.     *   **Router:** Se limpiaron las rutas antiguas `/clientes` y `/transportes`, centralizando todo en el mÃ³dulo `Hawe`. *   **Correcciones y Mejoras:**     *   **Iconos:** Se actualizaron todos los iconos a `fa-solid` (FontAwesome 6) para solucionar problemas de visualizaciÃ³n en listas y formularios.     *   **ProtecciÃ³n Fiscal:** Se implementÃ³ la lÃ³gica para impedir el borrado de domicilios fiscales en `DomicilioList.vue`.     *   **Consistencia UI:**         *   Se renombrÃ³ "Maestro de Segmentos" a "Administrar Segmentos".         *   Se habilitÃ³ el **doble click** en los tÃ­tulos "SEGMENTOS" (en `ClientCanvas.vue` y en el sidebar de `HaweView.vue`) y "LOGÃ�STICA" para abrir sus respectivas ventanas de administraciÃ³n.         *   Se restauraron los **iconos** (LÃ¡piz y Tacho) en las listas, asegurando su visibilidad con colores de alto contraste (`text-cyan-400` y `text-red-400`) y usando las clases mÃ¡s compatibles `fa-solid fa-pencil` y `fa-solid fa-trash` con dimensiones explÃ­citas (`w-4 h-4`).     *   **CorrecciÃ³n de Bug:** Se solucionÃ³ un error de sintaxis en `ClientCanvas.vue` (etiqueta `<aside>` mal cerrada) que surgiÃ³ durante la refactorizaciÃ³n.     *   **Infraestructura:** Se instalÃ³ **FontAwesome localmente** (`npm install @fortawesome/fontawesome-free`) y se eliminÃ³ la dependencia del CDN para garantizar que los iconos funcionen offline y sin bloqueos de navegador (Brave Shields, AdBlockers).     *   **Mejoras en DomicilioList:**         *   **Filtros:** Se agregaron los filtros "Todos / Activos / Inactivos".         *   **EdiciÃ³n:** Ahora al hacer click en el lÃ¡piz, se cierra la lista y se abre correctamente la pestaÃ±a de ediciÃ³n del domicilio seleccionado.         *   **Baja LÃ³gica (Soft Delete):** Se implementÃ³ la baja lÃ³gica para domicilios.             *   **Backend:** Se agregÃ³ la columna `activo` a la tabla `domicilios` mediante script de migraciÃ³n.             *   **Frontend:** La lista de domicilios ahora permite filtrar por estado.     *   **Mejoras en DomicilioForm:**         *   **Toggle Activo:** Se agregÃ³ un interruptor para activar/desactivar domicilios desde la ediciÃ³n.  ### [2025-11-30] RefactorizaciÃ³n LogÃ­stica y Domicilios (Tabs) *   **Cambio ArquitectÃ³nico:**     *   **Interfaz por PestaÃ±as:** Se reemplazÃ³ el uso de modales flotantes por un sistema de pestaÃ±as (`CLIENTE`, `DOMICILIO`, `CONTACTO`) integrado en el canvas central de `ClientCanvas.vue`.     *   **DomicilioForm:** ConversiÃ³n de componente modal a componente de canvas, con botones "Volver" y "Guardar" integrados. *   **UX/UI:**     *   **Sidebar LogÃ­stica:** Botones "FICHA - NUEVO" siempre visibles en cabecera de Domicilios.     *   **MenÃº Contextual:** Implementado en cabecera de Domicilios (Nuevo, Administrar) y en tarjetas individuales (Editar, Eliminar).     *   **NavegaciÃ³n:** Doble clic en tarjeta de domicilio abre la pestaÃ±a de ediciÃ³n correspondiente. *   **CorrecciÃ³n de Bugs:**     *   **InicializaciÃ³n Formulario:** Se corrigiÃ³ bug donde el doble clic abrÃ­a el formulario de alta en lugar de ediciÃ³n (watcher de `domicilio` con `immediate: true`).  ### [2025-11-29] ReplicaciÃ³n de MenÃº Contextual y ABM Maestros *   **Backend (Maestros):**     *   ImplementaciÃ³n de CRUD completo (API + Schemas) para `Provincias`, `CondicionesIva` y `TiposContacto`.     *   ValidaciÃ³n de integridad referencial y manejo de errores. *   **Frontend (Context Menu):**     *   **Componente Reutilizable:** CreaciÃ³n de `ContextMenu.vue` para uso global.     *   **Dashboard (HaweView):**         *   IntegraciÃ³n en lista lateral de "Segmentos" (Editar/Borrar).         *   IntegraciÃ³n en tarjetas de "Clientes" (Nueva Ficha, Administrar, Editar, Baja, IA).         *   IntegraciÃ³n en enlace "Clientes" del sidebar (Nuevo, Administrar).     *   **ClientCanvas:**         *   IntegraciÃ³n en etiqueta "Segmento" del formulario (Nuevo, Administrar). *   **UI/UX Refinements:**     *   **NavegaciÃ³n:** CorrecciÃ³n de flujo entre "Fichas", "Nuevo Cliente" y Dashboard.     *   **Estilos:** RediseÃ±o de botones en cabecera de ficha para evitar confusiÃ³n (Fichas resaltado, Nuevo sutil).     *   **Feedback:** Mejoras en la indicaciÃ³n visual de contexto.  ### [2025-11-27] Agenda y UX Avanzada (SesiÃ³n Nocturna) *   **MÃ³dulo Agenda:**     *   **Fix "Desconocido":** Se corrigiÃ³ el schema del backend para incluir datos de la persona en la respuesta del vÃ­nculo.     *   **EdiciÃ³n:** Se implementÃ³ la funcionalidad completa de ediciÃ³n de contactos (PUT) con botÃ³n dedicado.     *   **Roles al Vuelo:** ImplementaciÃ³n de creaciÃ³n de "Tipos de Contacto" directamente desde el formulario (F4). *   **UX Premium:**     *   **CopyTooltip:** Componente estilo "Gmail" para Email y WhatsApp. Al pasar el mouse, muestra el dato completo y permite copiarlo con un clic.     *   **WhatsApp Input:** Campo inteligente con prefijo automÃ¡tico (+54 9) y limpieza de basura. *   **Correcciones:**     *   **Fix 422:** SanitizaciÃ³n de payloads para evitar errores de validaciÃ³n con campos vacÃ­os.     *   **Fix Top Clients:** Se blindÃ³ el schema de `ClienteResponse` para tolerar valores nulos en `saldo` y `contador_uso`, recuperando la lista de frecuentes.     *   **Fix Import:** CorrecciÃ³n de referencia circular/errÃ³nea en `backend/clientes/router.py`.  ### [2025-11-27] Pulido de Clientes y Domicilios *   **CorrecciÃ³n de Bugs CrÃ­ticos:**     *   **Crash Frontend:** Solucionado `ReferenceError: onUnmounted` en `DomicilioGrid`.     *   **Error de Guardado:** Se eliminÃ³ el campo `zona_id` del payload de Domicilios ya que no existÃ­a en el modelo, permitiendo guardar direcciones con "S/N". *   **UX Domicilios:**     *   **Dashboard:** VisualizaciÃ³n en tiempo real de domicilios en la pestaÃ±a "General" (sin recarga).     *   **LÃ³gica de Transporte:**         *   **Auto-relleno:** Al crear un nuevo destino, copia el transporte del Domicilio Fiscal.         *   **Fallback:** Si se deja vacÃ­o, asigna automÃ¡ticamente "Retiro en Local" (o el primero disponible) al guardar.         *   **F10:** Se corrigiÃ³ la captura de tecla para que F10 guarde el modal de domicilio si estÃ¡ abierto.     *   **VisualizaciÃ³n:** Se filtrÃ³ el Domicilio Fiscal de la lista de entregas para evitar duplicados y conteo errÃ³neo.  ### [2025-11-25] RefactorizaciÃ³n Ramo -> Segmento *   **Cambio SemÃ¡ntico:** Se renombrÃ³ la entidad "Ramo" a "Segmento" en todo el sistema (Base de Datos, Backend, Frontend, DocumentaciÃ³n) para evitar ambigÃ¼edades con el concepto de "Rubro" de productos. *   **CorrecciÃ³n de Bugs:**     *   SoluciÃ³n a crash del Backend por error en Router de Maestros.     *   CorrecciÃ³n en mÃ³dulo Agenda (Personas): Se visualizaban como "Inactivos" por falta del campo `activo` en el schema de respuesta de la API. *   **UI Standard:** AlineaciÃ³n de filtros "Todos/Activos/Inactivos" a la derecha en todos los listados para consistencia con el mÃ³dulo Clientes.     *   Se actualizÃ³ `ClienteService` para propagar el transporte seleccionado en la ficha del cliente hacia su domicilio predeterminado (Fiscal/Entrega). *   **Frontend (ClienteForm):**     *   **Tab 1 (General):** IntegraciÃ³n de campos de domicilio legal para alta rÃ¡pida. CreaciÃ³n automÃ¡tica de domicilio Fiscal/Entrega al guardar.     *   **Transporte:** Campo obligatorio (con asterisco rojo). Se preselecciona "RETIRO EN LOCAL" si no hay otro.     *   **Persistencia:** Solucionado bug donde el transporte no se guardaba/recuperaba correctamente en clientes existentes. *   **SmartSelect:**     *   Soporte para propiedad `required` (asterisco rojo).     *   CorrecciÃ³n de "Race Condition" que borraba el valor seleccionado al cargar la lista asincrÃ³nicamente o al hacer click fuera prematuramente. *   **Base de Datos:**     *   Script de migraciÃ³n (`fix_legacy_transportes.py`) para asignar "RETIRO EN LOCAL" a todos los domicilios legados que no tenÃ­an transporte asignado.  ### [2025-11-25] EstandarizaciÃ³n UX Global (Norma DEOU) *   **ImplementaciÃ³n Masiva:** Se aplicaron las normas de atajos y comportamiento en todos los mÃ³dulos (Transportes, Ramos, Vendedores, Listas, Personas, Clientes).     *   `F10`: Guardar y Cerrar.     *   `F4`: Nuevo registro (en listados).     *   `Papelera`: BotÃ³n de baja lÃ³gica en listados. *   **Refactor TÃ©cnico:** CreaciÃ³n de composable `useKeyboardShortcuts` para manejo centralizado de eventos. *   **Base de Datos:** MigraciÃ³n para agregar campo `activo` a la tabla `personas`.  ### [2025-11-25] OperaciÃ³n ConstelaciÃ³n (Maestros SatÃ©lites) *   ImplementaciÃ³n de mÃ³dulos: Ramos, Vendedores, Listas de Precios, Agenda. *   Seed de transporte virtual "RETIRO EN LOCAL" (ID 1). *   Ajuste de UX en Transportes: Cierre automÃ¡tico de modal al guardar y botÃ³n de Baja.  ## [2025-12-05] RefactorizaciÃ³n UI Rubros y ProtecciÃ³n de Datos ### Cambios Realizados - **Frontend (RubrosView.vue):**   - ImplementaciÃ³n del patrÃ³n "Explorador + Inspector" (Bridge UI).   - Cabecera con filtros de estado (Todos/Activos/Inactivos) y bÃºsqueda.   - MenÃº de ordenamiento completo (A-Z, Z-A, Antiguos, Recientes).   - Toggle de "Baja RÃ¡pida" con confirmaciÃ³n en caso de desactivaciÃ³n.   - Inspector lateral siempre visible con "Empty State". - **Backend (productos/router.py):**   - Agregada validaciÃ³n en el endpoint `PUT /rubros/{id}`.   - **Regla de Negocio:** No se puede desactivar un rubro si tiene hijos activos o productos asociados activos.  ### Pendientes Identificados - **GestiÃ³n de Dependencias:** Se requiere una herramienta para reasignar hijos/productos cuando se desea eliminar un rubro padre (Wizard de ReasignaciÃ³n).  ### [2025-12-05] RefactorizaciÃ³n UI Clientes y Theming (SesiÃ³n Tarde) *   **Refactor UI Clientes:**     *   **Explorador + Inspector:** Se migrÃ³ `HaweView.vue` al patrÃ³n de lista izquierda y panel derecho (`ClienteInspector.vue`), eliminando la navegaciÃ³n a pantalla completa (`ClientCanvas`).     *   **Funcionalidad:** Alta, Baja (Soft Delete), ModificaciÃ³n y Listado integrados en el nuevo layout.     *   **Fix Sidebar:** Se eliminÃ³ la duplicaciÃ³n del menÃº lateral en `TransportesView.vue`. *   **Theming DinÃ¡mico:**     *   **Sidebar:** `AppSidebar.vue` ahora adapta su color de fondo y bordes segÃºn el mÃ³dulo activo (Azul para Clientes, Rosa para Rubros, Naranja para Transportes).     *   **Paleta Clientes:** Se implementÃ³ un tema "Cian/Azul Noche" (`#081c26`, `#05151f`) para diferenciarlo visualmente de otros mÃ³dulos, manteniendo la consistencia de contraste y luminosidad. *   **Correcciones:**     *   **Sintaxis:** Se corrigiÃ³ un error de cierre de etiquetas en `HaweView.vue`.     *   **Visibilidad:** Se ajustaron los colores de fondo del sidebar para que el tinte de color sea claramente perceptible.  ### [2025-12-06] ImplementaciÃ³n Toggle Status en Listado Clientes *   **Feature (Hawe):**     *   **Toggle en Lista:** Se agregÃ³ el interruptor (deslizador) de estado Activo/Inactivo a la vista de lista (renglones) del Explorador de Clientes (`HaweView.vue`).     *   **LÃ³gica Unificada:** Se creÃ³ la funciÃ³n `toggleClienteStatus` para manejar el cambio de estado tanto en la vista de CuadrÃ­cula como en la de Lista.     *   **Regla de Negocio:**         *   **Activar:** AcciÃ³n inmediata (sin confirmaciÃ³n).         *   **Desactivar:** Requiere confirmaciÃ³n del usuario ("Â¿EstÃ¡ seguro...?").     *   **Fix Bug:** Se corrigiÃ³ el comportamiento de los botones toggle en la vista de Fichas, que anteriormente llamaban a `handleInspectorDelete` forzando siempre la desactivaciÃ³n, lo que impedÃ­a reactivar clientes desde la UI.  ### [2025-12-06] CorrecciÃ³n CrÃ­tica: Alta de Clientes y Domicilios *   **Problema:** Bloqueo en el flujo de alta (`Deadlock UX`). La regla de negocio exige un domicilio fiscal para crear el cliente, pero la UI obligaba a crear el cliente antes de habilitar la carga de domicilios. *   **SoluciÃ³n (ClienteInspector):**     *   **Alta RÃ¡pida (Smart Form):** Se integrÃ³ un sub-formulario de "Domicilio Fiscal" en la pestaÃ±a General, visible solo durante la creaciÃ³n (`isNew`).     *   **ValidaciÃ³n:** Se impide guardar si falta direcciÃ³n, localidad o provincia.     *   **Payload:** Se empaqueta el domicilio fiscal dentro de la peticiÃ³n de creaciÃ³n del cliente (`nested write`). *   **CorrecciÃ³n de Datos (Clientes Rotos):**     *   Se habilitÃ³ la funcionalidad "Agregar Domicilio" en el inspector de ediciÃ³n. Ahora abre un formulario superpuesto (`DomicilioForm` overlay) que permite sanear clientes antiguos que quedaron sin direcciÃ³n ("sembrados incorrectamente").     *   Se implementÃ³ la lÃ³gica `handleDomicilioSaved` para persistir los cambios inmediatamente en el backend sin depender del guardado del cliente padre. *   **Maestros:**     *   Se conectÃ³ el selector de "CondiciÃ³n IVA" con el store de maestros dinÃ¡mico, reemplazando las opciones hardcodeadas que causaban inconsistencias.     *   Se asegurÃ³ la carga de Provincias y Transportes al abrir el inspector.  ### [2025-12-06] ImplementaciÃ³n CUIT Multi-Sede y Consistencia de Datos *   **Backend (Integridad de Datos):**     *   **EliminaciÃ³n Constraint UNIQUE:** Se eliminÃ³ la restricciÃ³n Ãºnica en el campo `cuit` de la tabla `clientes` para permitir mÃºltiples sucursales/facultades bajo el mismo CUIT institucional.     *   **Endpoint de VerificaciÃ³n:** Nueva lÃ³gica `check_cuit` que detecta duplicados y devuelve metadatos (RazÃ³n Social + Domicilio Principal) para asistir en la decisiÃ³n.     *   **SanitizaciÃ³n de Datos:** EjecuciÃ³n de script `fix_existing_cuits.py` que corrigiÃ³ dÃ­gitos verificadores invÃ¡lidos en la base de datos heredada. *   **Frontend (ClienteInspector UX):**     *   **ValidaciÃ³n Inteligente:** ValidaciÃ³n de CUIT (Algoritmo Modulo 11) en tiempo real (`@blur`).     *   **Alerta de Duplicados:** Sistema de advertencia no bloqueante (Amarillo) que lista las sedes existentes.         *   **AcciÃ³n "Switch":** Doble click en un Ã­tem carga el cliente existente (Modo EdiciÃ³n).         *   **AcciÃ³n "Nueva Sede":** BotÃ³n explÃ­cito para confirmar la creaciÃ³n de una nueva sucursal y descartar la advertencia.     *   **Correcciones Visuales:** Asterisco rojo en campos obligatorios, limpieza de anidamiento HTML excesivo.     *   **Estado del Panel:** ImplementaciÃ³n de encabezado persistente ("Inspector") y manejo correcto del estado "VacÃ­o" post-guardado. *   **GestiÃ³n de Maestros (CondiciÃ³n IVA):**     *   **Refactor a Manager:** ConversiÃ³n del formulario simple de CondiciÃ³n IVA a un **ABM Completo** (Lista, BÃºsqueda, Alta, EdiciÃ³n, Baja) integrado en el flujo de alta de clientes.     *   **Tech:** Uso de `<Teleport to="body">` para resolver problemas de apilamiento (z-index) con el backdrop del sidebar. *   **Estrategia Futura (ARCA/AFIP):**     *   Se definiÃ³ la estrategia para la facturaciÃ³n electrÃ³nica: "Offline First". Alta flexible con bandera de "VerificaciÃ³n Pendiente", conciliaciÃ³n asÃ­ncrona con padrÃ³n ARCA cuando haya conexiÃ³n, y uso de "Consumidor Final" como fallback temporal.  ### [2025-12-06] Estrategia de Carga Inicial (Golden Master) *   **DecisiÃ³n:** Se optÃ³ por una carga diferida mediante **Plantillas CSV/Excel** en lugar de dar acceso directo al sistema en desarrollo.     *   **Beneficio:** Permite avanzar con la carga real de datos de forma paralela sin "ensuciar" el entorno de desarrollo ni exponer al operador a cambios continuos.     *   **ImplementaciÃ³n Futura:** Se desarrollarÃ¡ un script de "ImportaciÃ³n Masiva" para ingestar estos CSV cuando el sistema alcance su versiÃ³n Release Candidate. *   **Requisito de SanitizaciÃ³n (CUIT):**     *   La herramienta de importaciÃ³n (y el sistema en general) debe ser **permisiva en la entrada** pero **estricta en el almacenamiento**.     *   **Caso de Uso:** El operador copia y pega CUITs desde Ã“rdenes de Compra (PDFs/Mails) que suelen tener guiones, barras o espacios (Ej: `30-11223344-6`).     *   **AcciÃ³n:** El sistema debe limpiar automÃ¡ticamente estos caracteres (`strip`) y guardar solo los 11 dÃ­gitos numÃ©ricos, ahorrando tiempo de ediciÃ³n manual al usuario. (Nota: Esto ya estÃ¡ parcialmente implementado en el Frontend `ClienteInspector`).  ### [2025-12-06] DefiniciÃ³n EstratÃ©gica: V5 como Producto y Data Intelligence Durante una sesiÃ³n de planificaciÃ³n conceptual ("Charla de Sistemas"), se pergeÃ±aron los siguientes pilares para el futuro del proyecto:  1.  **VisiÃ³n Comercial de Sonido LÃ­quido V5:**     *   **El Nicho:** No competir contra ERPs contables, sino ofrecer una soluciÃ³n para "el que no piensa en sistemas".     *   **La Diferencia:** Un sistema que piensa por el usuario. "Sacale una foto a tu cuaderno y yo te ordeno el pedido".     *   **Feature Star:** La capacidad de ingerir el caos (Excel, PDFs, Fotos) y devolver orden sin carga manual.  2.  **Estrategia de MigraciÃ³n "Smart Merge" (ARCA + Excel):**     *   **El Problema:** El Excel interno de pedidos tiene datos ricos pero sucios (nombres informales). ARCA (AFIP) tiene datos fiscales perfectos pero frÃ­os.     *   **La SoluciÃ³n:** TriangulaciÃ³n de datos.         *   Si en el Excel dice "LÃ¡cteos Poblet - 4 cajas" el 12/03 por $10.000...         *   Y en ARCA hay una factura a "Poblet S.A." el 13/03 por $10.000...         *   **Match:** El sistema infiere que el cliente informal corresponde a ese CUIT oficial.     *   **Resultado:** ConstrucciÃ³n automÃ¡tica de una Base de Clientes V5 depurada y enriquecida con historial fiscal real.   ### [2025-12-07] ConsolidaciÃ³n de Maestros y UX Avanzada *   **CorrecciÃ³n de Infraestructura:**     *   **ConexiÃ³n DB:** Se resolviÃ³ el error `FATAL: password authentication failed` identificando una contraseÃ±a desactualizada en el cÃ³digo de fallback (`backend/core/database.py`) y en el servidor PostgreSQL. Se unificÃ³ la credencial a la correcta.     *   **CORS:** Se ajustÃ³ la polÃ­tica CORS para permitir el desarrollo local y depuraciÃ³n segura. *   **PotenciaciÃ³n de Maestros (ABM CondiciÃ³n IVA):**     *   **API Usage check:** CreaciÃ³n de endpoint `GET .../usage` para verificar dependencias antes del borrado.     *   **Wizard de MigraciÃ³n:** ImplementaciÃ³n de un asistente visual que intercepta el borrado de condiciones en uso.         *   Muestra conteo y ejemplos de clientes afectados.         *   Permite **Reasignar** masivamente a otra condiciÃ³n existente.         *   Permite **Crear y Reasignar** a una nueva condiciÃ³n en el mismo flujo.     *   **Auto-Merge (UnificaciÃ³n):** DetecciÃ³n de duplicados por nombre al editar. Ofrece fusionar el registro actual con el existente, migrando automÃ¡ticamente los clientes. *   **CorrecciÃ³n de Calidad de Datos (ClienteInspector):**     *   **ValidaciÃ³n Estricta:** Se extendiÃ³ la validaciÃ³n de campos obligatorios (RazÃ³n Social, CUIT, Segmento, CondiciÃ³n IVA) tambiÃ©n a la **ediciÃ³n** de clientes, evitando inconsistencias como guardar con "Seleccionar..." (valor nulo).     *   **UX:** Se mejorÃ³ el comportamiento de los selectores para prevenir selecciones invÃ¡lidas accidentales.  ## [Protocolo de Seguridad] Siembra AutomÃ¡tica (Auth) **Contexto:** Debido a la volatilidad de los datos en entornos de desarrollo/nube, se ha implementado un mecanismo de 'Siembra' (seed.py).  **Funcionamiento:** 1. Al iniciar el backend (main.py), se invoca backend.core.seed.seed_all(). 2. Verifica existencia de Rol 'Administrador' (ID 1). Si falta, lo crea. 3. Verifica existencia de Usuario 'admin'. Si falta, lo crea (Pass: admin).   ### [2025-12-07] Mejoras Visuales y Fixes Interactividad (Clientes) *   **Enriquecimiento Visual (UI/UX):**     *   **Vista Lista:** Nuevas columnas para "Domicilio Fiscal" y "Contacto Principal", visibles en resoluciones medias/altas.     *   **Alerta de Entrega:** Indicador visual (Punto Naranja ðŸŸ ) en filas y tarjetas cuando el cliente posee un domicilio de entrega distinto al fiscal.     *   **Card Expansible:** Efecto hover en "Vista Grid" que despliega informaciÃ³n detallada (Segmento, DirecciÃ³n, Contacto) sin sobrecargar la vista inicial. *   **Interactividad:**     *   **Doble Click:** Se habilitÃ³ globalmente. Ahora abre el Inspector tanto desde la tarjeta como desde el renglÃ³n de la lista.     *   **MenÃº Contextual:** Se asegurÃ³ que la acciÃ³n "Editar" seleccione y cargue correctamente al cliente en el inspector. *   **Estabilidad Frontend:**     *   **Fix Sintaxis:** Se corrigiÃ³ un error de compilaciÃ³n (`Attribute name cannot contain...`) causado por una llave duplicada en `HaweView.vue`.     *   **Backend:** Propiedades calculadas en el modelo `Cliente` (`domicilio_fiscal_resumen`, etc.) para optimizar el rendimiento y lÃ³gica de presentaciÃ³n.    ### [2025-12-08] Rubros V5: Acciones Masivas y CorrecciÃ³n de Sintaxis *   **GestiÃ³n Masiva (Bulk Actions):**     *   **Funcionalidad:** ImplementaciÃ³n de "Mover Seleccionados" y "PromociÃ³n (Independizar)" en RubrosView.     *   **UI:** DiÃ¡logo de selecciÃ³n de destino y Wizard (`RubroReassignWizard`) para manejo de dependencias crÃ­ticas en operaciones destructivas.     *   **Backend:** Endpoint `POST /rubros/bulk_move` operativo. *   **Estabilidad Frontend:**     *   **Fix Sintaxis CrÃ­tico:** CorrecciÃ³n de erroes de cierre de etiquetas (`</div>`, `</main>`) en `RubrosView.vue` que causaban "Failed to fetch module".     *   **Layout:** RefactorizaciÃ³n de la estructura HTML para anidar correctamente el Inspector dentro del layout principal.     *   **VisualizaciÃ³n:** Ajuste en el filtrado para que los Sub-rubros no aparezcan en la grilla principal (RaÃ­z) salvo en bÃºsquedas explÃ­citas. *   **PrÃ³ximos Pasos (DiseÃ±o):**     *   Se definiÃ³ un nuevo requerimiento de diseÃ±o "Split Screen" (Maestro-Detalle vertical) para la gestiÃ³n de sub-rubros, a implementar en la siguiente sesiÃ³n.  ### [2025-12-09] FinalizaciÃ³n Modulo Rubros V5 (Split & UX) *   **ImplementaciÃ³n "Split Screen":**     *   **DiseÃ±o:** Nuevo layout vertical 66/33. Panel superior para Rubros Principales y panel inferior para Sub-rubros.     *   **Mecanismo:** El panel inferior reacciona dinÃ¡micamente a la selecciÃ³n del padre.     *   **VisualizaciÃ³n:** Soporte dual (Grid/List) en el panel principal. *   **CorrecciÃ³n de UX (Norma DEOU):**     *   **F10:** Se implementÃ³ el atajo global para guardar en el inspector (faltante en la primera versiÃ³n).     *   **Doble Click:** Se habilitÃ³ la apertura del inspector al hacer doble click en tarjetas y renglones. *   **CorrecciÃ³n de Bugs:**     *   **Sintaxis:** Se resolviÃ³ definitivamente el error de compilaciÃ³n `Invalid end tag` reescribiendo el componente para asegurar la integridad HTML.     *   **Router:** Se verificÃ³ la ruta correcta `/hawe/rubros`.     *   **Interactividad:** Se implementÃ³ el "Slider" (Toggle Switch) de activaciÃ³n/desactivaciÃ³n en las Fichas y en la Lista de Rubros, homologando el comportamiento con el mÃ³dulo Clientes. Incluye validaciÃ³n de integridad (no permite desactivar si tiene hijos).  ### [2025-12-09] VerificaciÃ³n de MigraciÃ³n Masiva y Seguridad *   **InvestigaciÃ³n "Rubro Destino":**     *   Se reportÃ³ imposibilidad de desactivar el rubro "Rubro Destino" (TS2).     *   **Causa:** El sistema protege correctamente la desactivaciÃ³n porque el rubro posee hijos activos ("1 Sub").     *   **ResoluciÃ³n:** Comportamiento esperado (Feature, no bug). El usuario debe usar el Inspector para gestionar la baja o reasignaciÃ³n. *   **Prueba de Carga (Stress Test):**     *   Se generÃ³ un dataset de prueba ("RUBRO MASIVO TEST") con 15 sub-rubros mediante script `seed_subrubros.py`.     *   **MigraciÃ³n Exitosa:** Se ejecutÃ³ el Wizard de eliminaciÃ³n, moviendo los 15 hijos a la categorÃ­a "HUÃ‰RFANOS" en una sola operaciÃ³n (`bulk_move`).     *   **Integridad:** El padre fue eliminado correctamente tras la limpieza de dependencias.  *   **Refinamiento UX (Smart Toggle):**     *   **Solicitud Usuario:** "Si intento desactivar con el slider, quiero que me deje gestionar los hijos, no solo que me bloquee".     *   **ImplementaciÃ³n:** Se modificÃ³ la lÃ³gica del Toggle Switch. Si el rubro tiene hijos, en lugar de mostrar una alerta bloqueante, se invoca automÃ¡ticamente al **Wizard de MigraciÃ³n** (mismo flujo que Eliminar).     *   **Resultado:** UX fluida que guÃ­a al usuario a la resoluciÃ³n del conflicto (reasignaciÃ³n) en lugar de un "punto muerto".  ### [2025-12-09] EstabilizaciÃ³n Productos y RefactorizaciÃ³n Rubros Flat *   **RefactorizaciÃ³n Mayor (Rubros Flat):**     *   **Cambio de Modelo:** Se eliminÃ³ la lÃ³gica jerÃ¡rquica (Padre/Hijo) en el frontend para simplificar la categorizaciÃ³n. Ahora `RubrosView` muestra una grilla plana unificada.     *   **Backend:** Se simplificÃ³ `GET /rubros` para devolver todos los registros sin filtrar por `padre_id`.     *   **UI:** Se eliminÃ³ la vista de pantalla dividida ("Split Pane"). Se migraron los controles de Ordenamiento y Vistas (Grid/List) para coincidir con `HaweView` (Clientes).     *   **OptimizaciÃ³n de Carga:** Se migrÃ³ el estado de Rubros al `useProductosStore` (Pinia) para mantener los datos en memoria y evitar el parpadeo de carga ("flash") al navegar entre pestaÃ±as.  *   **Estabilidad ProductosView:**     *   **Fix Reload Loop:** Se reescribiÃ³ `ProductosView.vue` desde cero para limpiar errores de anidamiento HTML que causaban recargas infinitas y errores 500 en Vite.     *   **Performance:** La carga inicial se optimizÃ³ al usar la lista plana de rubros cacheada.  *   **CorrecciÃ³n de Bugs (En Proceso):**     *   **Flash al Hover (Rubros):** Se detectÃ³ un problema donde, al pasar el mouse por una ficha con efecto de lupa (`scale`), el contenedor colapsaba y generaba un bucle de `mouseenter`/`mouseleave`.     *   **SoluciÃ³n Aplicada:** Se agregÃ³ `min-h-[140px]` al contenedor de la grilla en `RubrosView.vue` para reservar el espacio fÃ­sico.     *   **Estado:** El usuario reportÃ³ que el problema persistÃ­a antes de cerrar la sesiÃ³n. Pendiente de verificaciÃ³n visual profunda en prÃ³xima sesiÃ³n.  *   **Estado del Sistema:**     *   **Productos:** Operativo, carga rÃ¡pida.     *   **Rubros:** Operativo (Flat), bug visual menor pendiente de confirmaciÃ³n.     *   **Backend:** Estable, sin errores de recursiÃ³n.  ### [2025-12-09] FinalizaciÃ³n Rubros V5 (Bug Fix Hover) *   **CorrecciÃ³n Visual (Flash al Hover):**     *   **DiagnÃ³stico:** Se identificÃ³ conflicto de transformaciones CSS entre el control de la grilla (`RubrosView`) y la lÃ³gica interna de escalado (`FichaCard`). La doble aplicaciÃ³n de `transform` causaba parpadeo y bucles de evento.     *   **SoluciÃ³n:** Se eliminaron las clases redundantes `transition-transform duration-200 hover:-translate-y-1` en `RubrosView.vue`, dejando que el componente `FichaCard` maneje exclusivamente su estado visual (Doctrina de encapsulamiento). *   **VerificaciÃ³n:**     *   El mÃ³dulo Rubros ahora sigue estrictamente el estÃ¡ndar visual de `HaweView` (Clientes) y `TransportesView`.     *   **Estado:** MÃ³dulo Rubros CERRADO y ESTABLE.  ### [2025-12-09] EstabilizaciÃ³n Productos (Fix Loop Hover) *   **CorrecciÃ³n Bug CrÃ­tico (Infinite Reload Loop):**     *   **SÃ­ntoma:** "Flasheo" e inestabilidad al pasar el mouse por tarjetas de Productos.     *   **Causa:** La tarjeta emitÃ­a el evento `select` al hacer hover, lo que disparaba un `fetch` al backend, que a su vez refrescaba la lista y reiniciaba el componente, creando un ciclo infinito.     *   **SoluciÃ³n:**         *   Se deshabilitÃ³ el `emit('select')` automÃ¡tico en el evento `mouseenter` de `ProductoCard.vue`.         *   Se eliminÃ³ el posicionamiento `absolute` forzado en `ProductosView.vue` para respetar la lÃ³gica interna de expansiÃ³n de la tarjeta.     *   **Resultado:** El efecto "Lupa" (Zoom) funciona visualmente, pero la selecciÃ³n (y carga de datos) requiere un **Click** explÃ­cito, homologando el comportamiento con el mÃ³dulo Clientes.  ### [2025-12-09] Mejoras de UX (Toggle Switch) *   **Feature:** Se replicÃ³ el control de estado de Clientes en el mÃ³dulo de Productos.     *   **Visual:** Interruptor deslizante (Slider) Verde/Rojo en lugar de checkboxes.     *   **LÃ³gica:**         *   **Activar:** Inmediato.         *   **Desactivar:** Requiere confirmaciÃ³n explÃ­cita (Dialogo del navegador) para evitar accidentes operativos.     *   **Arquitectura:** Se implementÃ³ un `slot` de acciones en `ProductoCard` para inyectar botones contextuales sin ensuciar el componente base.  ### [2025-12-09] EstandarizaciÃ³n de UI (Productos) *   **Barra de Herramientas:**     *   **Filtros de Estado:** Se reemplazÃ³ el botÃ³n simple de "Inactivos" por un grupo de botones (Todos | Activos | Inactivos) consistente con el mÃ³dulo de Clientes.     *   **Ordenamiento:** Se refinÃ³ el menÃº de ordenamiento, aÃ±adiendo "Recientes" y mejorando la presentaciÃ³n.     *   **Estilos:** Se corrigiÃ³ el contraste de los desplegables (Rubros) usando fondo oscuro (`#1a050b`) y texto blanco para mejorar la legibilidad. *   **Inspector de Producto:**     *   **CorrecciÃ³n Visual:** Se aplicÃ³ el mismo estilo de alto contraste (Fondo Oscuro/Texto Blanco) a todos los selectores del formulario (Rubro, Tipo, Unidades, Proveedor, IVA) para eliminar problemas de legibilidad con fondos semitransparentes.  ### [2025-12-09] RefactorizaciÃ³n de UI (Productos) *   **Tarjeta de Producto:**     *   **ReubicaciÃ³n de Status:** Se moviÃ³ el interruptor de estado (Slider) a la esquina superior derecha, integrando la funcionalidad de "Indicador de Estado" y "Control de ActivaciÃ³n" en un solo elemento. Esto liberÃ³ la zona inferior de la tarjeta para evitar que el texto "Click para editar" fuera obstruido. *   **Layout General:**     *   **Z-Index Header:** Se elevÃ³ el Z-Index de la barra superior a `30` para asegurar que el botÃ³n "Nuevo" y los filtros permanezcan accesibles y visibles incluso si el Inspector (`z-20`) solapa el contenido en resoluciones ajustadas.     *   **Hotfix:** Se corrigiÃ³ un error de sintaxis en `handleSearch` (parÃ©ntesis faltante) introducido durante la refactorizaciÃ³n anterior.  ### [2025-12-09] CorrecciÃ³n de LÃ³gica de Toggle y API (Productos) *   **CorrecciÃ³n Frontend (ProductosView):**     *   Se solucionÃ³ un `ReferenceError` en `handleToggleActive` donde se referenciaba `id` en lugar de `producto.id` al intentar cerrar el inspector tras desactivar un producto. *   **ImplementaciÃ³n API Backend:**     *   **Endpoints Faltantes:** Se detectÃ³ que la API no exponÃ­a rutas para actualizaciÃ³n y borrado lÃ³gico de productos, causando error 405.     *   **ADD `PUT /productos/{id}`:** Se implementÃ³ el endpoint para actualizar productos y sus costos asociados.     *   **ADD `DELETE /productos/{id}`:** Se implementÃ³ el endpoint para realizar el *toggle* del estado `activo` (Borrado LÃ³gico), alineado con la expectativa del frontend.  ### [2025-12-09] Refinamiento de UI y LÃ³gica (Productos) *   **Ajustes de Interfaz:**     *   **Z-Index Inspector:** Se aumentÃ³ a `z-40` para garantizar que cubra la cabecera (`z-30`) y evitar superposiciones indeseadas.     *   **Toggle en Inspector:** Se agregÃ³ un interruptor de "Activado/Desactivado" en la cabecera del Inspector, permitiendo cambiar el estado del producto sin cerrar la ficha. *   **Mejora de Backend:**     *   **Filtros de API:** Se actualizÃ³ `GET /productos/` para aceptar parÃ¡metros `activo` (bool) y `rubro_id` (int), permitiendo que los botones "Todos/Activos/Inactivos" del frontend filtren realmente en la base de datos en lugar de depender solo del cliente.  ### [2025-12-09] Refinamiento de UI (Ronda 2) *   **CorrecciÃ³n de SuperposiciÃ³n:**     *   **Espaciado:** Se redujo el ancho de la barra de bÃºsqueda (`w-96` -> `w-64`) para liberar espacio horizontal y evitar colisiones botones/inspector.     *   **Z-Index Definitivo:** Se subiÃ³ el Inspector a `z-50` para asegurar que ningÃºn elemento (como el botÃ³n "Nuevo") pueda quedar encima de Ã©l. *   **LÃ³gica de Refresco:**     *   **Consistencia de Listado:** Se implementÃ³ una lÃ³gica de auto-refresh (`fetchProductos`) al cambiar el estado de un producto (Activar/Desactivar) si el filtro actual ("Activos" o "Inactivos") ya no coincide con el nuevo estado del Ã­tem, asegurando que el producto desaparezca/aparezca segÃºn corresponda instantÃ¡neamente.  ### [2025-12-09] EstandarizaciÃ³n de Estilos UI *   **Botones de Filtro (Estado):** Se unificÃ³ la paleta de colores para los filtros de estado en **Clientes, Productos y Transportes**:     *   **Todos:** Indigo/Violeta (`bg-indigo-500/20 text-indigo-300`).     *   **Activos:** Verde (`bg-green-500/20 text-green-300`).     *   **Inactivos:** Rojo (`bg-red-500/20 text-red-300`). *   **Ajuste de Contraste:** Se incrementÃ³ la opacidad de los botones a `bg-[color]-600/70` y se cambiÃ³ el texto a `text-white` para mejorar la legibilidad y el "pop" visual, manteniendo la transparencia moderna pero con mayor peso. *   **Ajuste de Contraste:** Se incrementÃ³ la opacidad de los botones a `bg-[color]-600/70` y se cambiÃ³ el texto a `text-white` para mejorar la legibilidad y el "pop" visual, manteniendo la transparencia moderna pero con mayor peso. *   **DocumentaciÃ³n:** Se actualizÃ³ `ARQUITECTURA_Y_DOCTRINA_V5.txt` con estas normas de estilo.  ### [2025-12-09] ImplementaciÃ³n de Arquitectura LogÃ­stica *   **Nueva Entidad "Estrategia LogÃ­stica" (Domicilios):**     *   **Base de Datos:** Se agregaron columnas `metodo_entrega`, `modalidad_envio` y `origen_logistico` a la tabla `domicilios`.     *   **Backend:** Se actualizaron Modelos y Schemas (`Clientes`) para soportar estos nuevos campos.     *   **Frontend (DomicilioForm):** Se reemplazÃ³ el selector simple de transporte por un **Wizard LogÃ­stico** que permite definir:         1.  **MÃ©todo:** Retiro Local / Transporte / Moto / Plataforma.         2.  **Transportista:** SelecciÃ³n de empresa (Si aplica).         3.  **Modalidad:** A Domicilio / A Sucursal.         4.  **Origen:** Despachamos Nosotros / Nos Retiran (Colecta).     *   Esto cubre los 8 escenarios logÃ­sticos planteados por el usuario.  ### [2025-12-10] DefiniciÃ³n LÃ³gica LogÃ­stica y CorrecciÃ³n API *   **Hito:** Se definiÃ³ la lÃ³gica de negocio para indicadores logÃ­sticos en Clientes (Punto Naranja). *   **LÃ³gica:**     *   **Punto Naranja (Requiere Entrega):** Se activa solo si el cliente tiene un domicilio marcado como `es_entrega=True` Y que NO sea `ORIGEN_LOGISTICO='RETIRO_EN_PLANTA'`.     *   **Retiro en Planta:** Es el escenario por defecto (ej: Comisionista Juan). No requiere acciÃ³n nuestra, por ende no lleva indicador.     *   **Excepciones:** Las desviaciones del hÃ¡bito (ej: "Hoy mandalo por Pepe") se manejan en el **Pedido**, no en la ficha del cliente. *   **Bug CORS/500 Resuelto:**     *   **SÃ­ntoma:** Error de CORS al guardar domicilios.     *   **Causa:** La ruta `PUT /clientes/{id}/domicilios/{id}` declaraba `response_model=DomicilioResponse` pero el servicio devolvÃ­a un objeto `Cliente` (para actualizar la UI). Esto generaba un error de validaciÃ³n Pydantic (500) invisible.     *   **SoluciÃ³n:** Se actualizÃ³ `response_model` a `ClienteResponse` en `backend/clientes/router.py`. *   **UX Domicilio:**     *   Se simplificÃ³ `DomicilioForm.vue` moviendo flags Fiscal/Estado al encabezado y eliminando redundancias en el pie. *   **Refactor UI Segmentos:**     *   Se actualizÃ³ `SegmentoList` (modal apilado en Clientes) para eliminar el fondo blanco y usar el tema Dark Blue (`#0a1f2e`).     *   **Arquitectura:** Se migrÃ³ de Modal simple a **Inspector Lateral**, unificando la UX con el mÃ³dulo de Clientes y Productos.     *   **Router:** Se moviÃ³ la ruta `/segmentos` bajo el layout `HaweLayout` para evitar la duplicaciÃ³n de Sidebar.     *   **Sidebar UX:** Se implementÃ³ resaltado visual del "Grupo Padre" (Ej: Clientes) cuando un mÃ³dulo hijo (Ej: Segmentos) estÃ¡ activo, para mejor orientaciÃ³n del usuario.     *   Se corrigiÃ³ error de sintaxis en el componente `SegmentoList.vue`.     *   **Layout LogÃ­stica:** Se adoptÃ³ el patrÃ³n "Split-Pane" (Panel Dividido) para Segmentos, replicando la estructura de **Transportes** (Lista Izquierda + Inspector Fijo Derecha) para garantizar visibilidad y consistencia.     *   **DocumentaciÃ³n:** Se actualizÃ³ `MANUAL_OPERATIVO_V5.md` con la nueva secciÃ³n de AdministraciÃ³n de Segmentos.  > [!NOTE] > **Estado Final de SesiÃ³n:** MÃ³dulo de Segmentos operativo y consistente con la estÃ©tica V5 (Dark/Cyan). Sidebar unificado y navegaciÃ³n clara.  ### [2025-12-10] Inicio Fase Piloto y MinerÃ­a de Datos *   **Hito EstratÃ©gico:** Se definiÃ³ la estrategia de **ImplementaciÃ³n Paralela (Piloto)**.     *   **Arquitectura:** CreaciÃ³n de entorno portable BUILD_PILOTO (separado de Dev) para despliegue en producciÃ³n local sin riesgo para el cÃ³digo fuente.     *   **Objetivo:** Validar funcionalidad V5 con datos reales y sustituir progresivamente el Excel de pedidos. *   **IngenierÃ­a de Datos (Harvesting):**     *   Se desarrollÃ³ y ejecutÃ³ script harvest_excel.py para minar la historia transaccional (pedidos_raw.xlsx).     *   **Resultado:** ExtracciÃ³n exitosa de ~200 Clientes y ~300 Productos crudos (Formatos heterogÃ©neos detectados).     *   **Archivos Generados:** BUILD_PILOTO/data/clientes_raw.csv y productos_raw.csv. *   **PlanificaciÃ³n (Roadmap V5.3):**     *   Se diseÃ±Ã³ el concepto de **Cargador TÃ¡ctico**: Una vista simplificada en V5 que permite cargar pedidos, guardar en BD limpia y exportar a Excel (Formato cliente) simultÃ¡neamente.     *   Se generaron documentos rectores: PLAN_TECNICO_GY.md y INFORME_ESTRATEGICO_USUARIO.md.  > [!IMPORTANT] > **PrÃ³xima SesiÃ³n:** Foco total en **Limpieza de Datos** (Herramientas UI de FusiÃ³n) e implementaciÃ³n del **Cargador TÃ¡ctico**.  ### [2025-12-11] ImplementaciÃ³n Data Intelligence (Piloto) y EstabilizaciÃ³n UI *   **Data Cleaner UI (Herramienta CrÃ­tica):**     *   **Desarrollo:** Se creÃ³ la interfaz visual `DataCleaner.vue` para la curaciÃ³n masiva de datos candidatos (clientes y productos extraÃ­dos del Excel legado).     *   **Funcionalidades:**         *   **EdiciÃ³n en LÃ­nea:** CorrecciÃ³n de nombres mal escritos (Ej: "JabÃ³n Liq" -> "JabÃ³n LÃ­quido").         *   **ValidaciÃ³n de CUIT:** VerificaciÃ³n en tiempo real con algoritmo Modulo 11 y formateo automÃ¡tico.         *   **Sort & Group:** Ordenamiento inteligente por "Frecuencia" (para identificar productos top) y "Nombre Original" (para agrupar variantes).         *   **Estabilidad UI:** Se resolviÃ³ un bug de "Cursor Saltador" usando claves estables (`_id`) y ordenamiento inmutable (`nombre_original`) durante la ediciÃ³n. *   **Commit System (Backend):**     *   **Endpoint:** ImplementaciÃ³n de `POST /data_intel/commit/{type}`.     *   **LÃ³gica de Negocio:**         *   Toma registros marcados como "IMPORTAR".         *   Verifica duplicados en la base de datos de producciÃ³n (SQLite).         *   Si es producto, asegura/crea rubro "GENERAL" por defecto.         *   Inserta los registros limpios en las tablas `clientes` o `productos`.     *   **SanitizaciÃ³n:** ImplementaciÃ³n de forzado de tipos (String) en el frontend para evitar errores de validaciÃ³n Pydantic (422) con alias numÃ©ricos. *   **Hito Piloto:**     *   Se validÃ³ el ciclo completo: ExtracciÃ³n (Excel) -> Limpieza (UI) -> Persistencia (SQLite).     *   El sistema "Piloto" (`BUILD_PILOTO`) quedÃ³ en estado operativo estable para iniciar la carga de datos reales.   > [!CAUTION] > **PrÃ³ximo Paso CrÃ­tico:** AuditorÃ­a forense de la base de datos SQL Server en la nube (IOWA) para evaluar migrabilidad.  ### [2025-12-11] Estrategia de Respaldo "Golden Seeds" *   **DefiniciÃ³n:** Se estableciÃ³ como polÃ­tica de seguridad la generaciÃ³n periÃ³dica de archivos CSV planos (`SEMILLAS_MAESTRAS`) que contengan el estado completo de las tablas crÃ­ticas (Clientes, Productos, Transportes, etc.). *   **PropÃ³sito:** Servir como "Arca de NoÃ©" ante catÃ¡strofes tecnolÃ³gicas. Si se pierde la DB (Local y Nube), el sistema puede reconstruirse desde estos archivos. *   **Requerimiento Futuro (V5):** Implementar una utilidad de usuario "Backup de Emergencia" que invite al operador a descargar estos CSV a un soporte externo (Drive, Pendrive) regularmene.  ### [2025-12-11] DiseÃ±o: Cargador TÃ¡ctico "Excel Killer" *   **DefiniciÃ³n:** Se aprobÃ³ el diseÃ±o tÃ©cnico (`DISEÃ‘O_CARGADOR_TACTICO.md`) para el mÃ³dulo de carga de pedidos de alta velocidad. *   **CaracterÃ­sticas:** UI tipo Grilla, navegaciÃ³n 100% teclado, buscador semÃ¡ntico (F3), Feedback en tiempo real. *   **Estado:** Listo para desarrollo. Fase 1 (Esqueleto UI) pendiente para la prÃ³xima sesiÃ³n.  ## [2025-12-11] ConsolidaciÃ³n Data Cleaner y SincronizaciÃ³n Piloto  ### Resumen ImplementaciÃ³n final del flujo de "Data Cleaner" para la importaciÃ³n y validaciÃ³n de datos maestros. Se resolviÃ³ la persistencia de duplicados, se mejorÃ³ la UX para la correcciÃ³n de errores (CUITs truncados) y se estableciÃ³ la sincronizaciÃ³n unidireccional hacia la nube.  ### Implementaciones Clave 1.  **ValidaciÃ³n Inteligente de Duplicados (Smart Update):**     *   **LÃ³gica:** Si el CUIT/Nombre existe Identico -> `EXISTENTE` (Skip). Si difiere -> `ACTUALIZADO` (Update).     *   **Persistencia:** CorrecciÃ³n crÃ­tica en `router.py` para asegurar que el estado (`EXISTENTE`) se guarde en el CSV fÃ­sico (`df.to_csv`), evitando bucles infinitos de procesamiento. 2.  **UX "Dirty State":** DetecciÃ³n automÃ¡tica de cambios en el frontend. Si el usuario edita un campo de un registro grisado, este se reactiva (`IMPORTAR`) automÃ¡ticamente. 3.  **CorrecciÃ³n de CUITs:** AmpliaciÃ³n del input de CUIT a 15 caracteres para permitir guiones, aunque se guarden solo los dÃ­gitos. 4.  **Workflow sin Bloqueos:** HabilitaciÃ³n permanente del botÃ³n `IMPORTAR (F10)` eliminando la obligatoriedad de "Guardar" previo (el sistema auto-guarda). 5.  **Cierre de Ciclo (Cloud Sync):** CreaciÃ³n y ejecuciÃ³n de `scripts/push_pilot_to_cloud.py` para subir los datos validados (`_master.csv`) al entorno remoto (Postgres IOWA).  ### DecisiÃ³n de Arquitectura: "Master CSV Strategy" Se formalizÃ³ en `PROTOCOLO_DATOS.md` que la fuente de verdad son los archivos `clientes_master.csv` y `productos_master.csv`, siendo la DB SQLite un derivado operacional y la Nube un espejo de respaldo.  ### Estado Final *   **Data Cleaner:** Operativo y estabilizado. *   **GestiÃ³n de Duplicados:** Resuelto. *   **Nube:** Sincronizada con 11 clientes validados.  ### âš  AVISO DE NAVEGACIÃ“N (PrÃ³xima SesiÃ³n) **DOCUMENTO DE LECTURA OBLIGATORIA:** `PROTOCOLO_DATOS.md` Antes de cualquier operaciÃ³n de carga o mantenimiento de datos, leer el protocolo definido en esta sesiÃ³n. ### [2025-12-12] Pivot EstratÃ©gico: OperaciÃ³n Nike (Doctrina de Sanidad) *   **Contexto:** Se detectÃ³ que el enfoque de "ImportaciÃ³n Perfecta" (limpiar todo antes de cargar) era inviable y generaba fricciÃ³n operativa. *   **Nueva Doctrina (Nike Report):**     1.  **DepuraciÃ³n Just-in-Time:** Se acepta la carga "sucia". La limpieza ocurre en la trinchera, al momento de cargar un pedido.     2.  **Fuente de Verdad:** La Base de Datos V5 es la autoridad suprema.     3.  **Golden Seeds (Blindaje):** Respaldo automÃ¡tico de tablas maestras a CSV planos tras cada sesiÃ³n. "Punto de RestauraciÃ³n Institucional". *   **Dispositivo TÃ¡ctico (Grid V5):**     *   Interfaz de carga de alta velocidad ("Excel Killer").     *   **SemÃ¡foro de AuditorÃ­a (F3):**         *   ðŸŸ¢ **VERDE:** Listo para facturar.         *   ðŸ”´ **ROJO:** Requiere intervenciÃ³n (Inspector).         *   ðŸ—‘ï¸� **KILL:** Basura / Duplicado -> Soft Delete. *   **PrÃ³ximos Pasos:** Desarrollo del `TacticalView` y componente de SemÃ¡foro.  > [!IMPORTANT] > **Base de Datos:** Se confirma que la operaciÃ³n inicia sobre la base SQLite local (`pilot.db`), respaldada por los CSVs maestros.   ### [2025-12-14] Refinamiento TÃ¡ctico y Arquitectura Unificada (Refactor 5 Puntos) *   **Hito ArquitectÃ³nico (Respuesta a Inquietud de DesvÃ­o):**     *   **ConfirmaciÃ³n de Unidad:** Se valida que el "Cargador TÃ¡ctico" (`GridLoader.vue`) y el sistema V5 (`HaweView.vue`) comparten el **100% de los componentes maestros**.     *   **Evidencia:** El arreglo del `ClienteInspector` (usado para corregir CUITs) se aplicÃ³ una sola vez y corrigiÃ³ instantÃ¡neamente ambos mÃ³dulos. No existen "ramas ocultas" ni cÃ³digo duplicado divergente. *   **ImplementaciÃ³n de Mejoras (User Feedback):**     *   1. **Segmentos ABM:** ConexiÃ³n de `SimpleAbmModal` en el entorno tÃ¡ctico.     *   2. **Fix CUIT Header:** Reactividad corregida en el inspector unificado.     *   3. **Toasts (Feedback):** Notificaciones visuales de Ã©xito al guardar.     *   4. **Autosave TÃ¡ctico:** ImplementaciÃ³n de persistencia local (`localStorage`) para evitar pÃ©rdida de pedidos borrador.     *   5. **Persistencia de Orden:** Memoria de preferencia de ordenamiento en listados. *   **Incidente y CorrecciÃ³n RÃ¡pida:**     *   **Crash:** Pantalla blanca por `ReferenceError: watch`.     *   **SoluciÃ³n:** ImportaciÃ³n faltante agregada en `GridLoader.vue` y `HaweView.vue`.     *   **Crash:** `Invalid prop: clienteId` en `ClientCanvas`.     *   **SoluciÃ³n:** ProtecciÃ³n `v-if="form.id"` agregada a `ContactoForm` para evitar renderizado prematuro.     *   **UX:** Teclas `F3` y `F4` saltaban a Cliente globalmente.     *   **SoluciÃ³n:** Se eliminÃ³ la captura global en `GridLoader` para respetar el contexto local (ej. bÃºsqueda de productos).     *   **Bug:** Segmento ABM no guardaba (Error de ID).     *   **SoluciÃ³n:** Se corrigiÃ³ `SegmentoInspector` para no enviar ID vacÃ­o (autogenerado por backend) y se limpiÃ³ el payload en `SegmentoList`.     *   **UX:** Alerta "CUIT Compartido" molesta en Consumidor Final (`00000000000`).     *   **SoluciÃ³n:** Se aÃ±adiÃ³ una excepciÃ³n en el backend (`ClienteService.check_cuit`) para ignorar la verificaciÃ³n de duplicados si el CUIT es genÃ©rico (todos ceros), permitiendo mÃºltiples "Consumidores Finales" sin alertas.    ### 2025-12-15 13:10 - Protocolo de Sincronización de Datos (Anti-Desliz) > [!IMPORTANT] > **LECCIÓN APRENDIDA:** El código viaja por Git, pero los **DATOS** (SQLite) viajan por **Semillas (CSV)**. > > **Problema:** Se trabajó en una ubicación (CA), se agregaron clientes/productos, pero no se exportaron las semillas. Al llegar a la otra ubicación (OF), el código estaba actualizado pero la base de datos vacía o desactualizada. > **Intento Fallido:** Se intentó conectar a la Nube (IOWA) como backup, pero falló por timeout (Firewall/IP).  **PROTOCOLO OBLIGATORIO AL TERMINAR SESIÓN (HANDOVER):** 1.  **Ejecutar:** python scripts/export_master_seeds.py (Exporta DB -> CSV en SEMILLAS_MAESTRAS/). 2.  **Verificar:** Que los archivos .csv tengan fecha/hora actual. 3.  **Git:** git add SEMILLAS_MAESTRAS/ -> commit -> push.  **PROTOCOLO AL INICIAR SESIÓN:** 1.  **Git:** git pull. 2.  **Verificar:** Si hay nuevos CSVs en SEMILLAS_MAESTRAS/. 3.  **Ejecutar:** python scripts/restore_seeds.py (Importa CSV -> DB Local).  ## [2025-12-15] RefactorizaciÃ³n de Flujo de Pedidos - **DB**: Added 	ipo_comprobante column (scripts/add_tipo_to_pedidos.py). - **API**: Updated Pedido Create/Update schemas and router logic. - **UX**: Implemented Gmail-style drafts (Auto-save, no prompts). - **UX**: Unified status control via Dropdown (Pendiente triggers Fiscal/X prompt). - **Fix**: Resolved CORS/500 crash due to migration script path issue. - **Fix**: Repaired invalid Vue template in PedidoInspector.  ## [2025-12-16] ImplementaciÃ³n Motor de Precios V5  ### Contexto El usuario requerÃ­a formalizar la lÃ³gica de "precios sugeridos" que hasta ahora era mental. Se definiÃ³ la doctrina "La Roca y La MÃ¡scara" para manejar la dualidad entre Costo Real y Precio de Lista (Vidriera).  ### Cambios TÃ©cnicos 1.  **Base de Datos:**     *   `productos_costos`: Agregado `precio_fijo_override` (Numeric), `permitir_descuentos` (Bool).     *   `clientes`: Agregado `estrategia_precio` (String/Enum).     *   Script de migraciÃ³n: `scripts/update_db_pricing_engine.py`.  2.  **Backend:**     *   Nueva clase `backend.pedidos.pricing.PricingEngine`.     *   Nuevo endpoint `POST /pedidos/cotizar`.     *   LÃ³gica de escenarios (K-Factors): `MAYORISTA_FISCAL`, `MAYORISTA_X`, `MELI_CLASICO`.  3.  **Frontend (`GridLoader`):**     *   IntegraciÃ³n con endpoint de cotizaciÃ³n.     *   Componente `MagicInput.vue`: Input que evalÃºa expresiones matemÃ¡ticas (`eval` sanitizado local).  ### VerificaciÃ³n Script `scripts/war_game_pricing_v5_fix.py` ejecutado con Ã©xito. - Validado cÃ¡lculo reverso de descuentos. - Validado markup de MELI. - Validado override de precios fijos.  ## Pendientes para esta sesiÃ³n (Rescatado de OF)  ### Hallazgos y Pendientes 1.  **Campo OC (Orden de Compra):** Existe en BD (pedidos.oc) pero falta en:     *   Schema PedidoResponse (Backend).     *   UI PedidoTacticoView (Input explÃ­cito).     *   UI PedidoInspector (EdiciÃ³n). 2.  **UX TÃ¡ctico:** Falta botÃ³n 'Limpiar/Nuevo' explÃ­cito para resetear el borrador sin recargar. 3.  **Plan de AcciÃ³n:** Se generÃ³ el implementation_plan.md para abordar estos puntos en la prÃ³xima sesiÃ³n.  ### Nota Post-Cierre Se intentÃ³ correr una 'SimulaciÃ³n de Integridad' (Frontend Build + Backend Tests), pero se abortÃ³ por falta de tiempo. Queda pendiente verificar el estado del servidor y tests de integraciÃ³n en la prÃ³xima sesiÃ³n.  --- ## [SESIÓN 17-DIC-2025] - Limpieza Profunda y Acceso LAN  ### Objetivo Habilitar herramientas para la 'depuración masiva' de la base de datos (clientes/productos basura) y configurar el entorno para permitir la carga de datos concurrente desde múltiples puestos (LAN).  ### Logros 1.  **Limpieza Masiva (Bulk Hard Delete):**     *   Implementado mecanismo de 'Doble Fase':         *   **Fase 1 (Naranja):** Desactivación masiva (Soft Delete) desde el filtro 'Activos'.         *   **Fase 2 (Rojo):** Eliminación definitiva (Hard Delete) desde el filtro 'Inactivos'.     *   Aplicado tanto en **Clientes** como en **Productos**.     *   **Seguridad:** Backend protege registros con integridad referencial (no deja borrar si tienen ventas).  2.  **Sanitización de CUITs:**     *   **Frontend:** El inspector limpia automáticamente guiones y espacios al guardar.     *   **Backend:** Validator Pydantic ('clean_cuit') fuerza string numérico de 11 dígitos.     *   Resultado: Se permite input flexible ('20-1234...') pero se guarda limpio ('201234...').  3.  **Acceso Remoto (LAN / Multijugador):**     *   **Configuración Backend:** CORS habilitado para '*' (Wildcard).     *   **Configuración Firewall:** Scripts para abrir puertos 8000 (API) y 5173 (Web).     *   **Hardcoding de IP:** Se fijó la IP '192.168.0.34' en 'api.js' y 'Login.vue' para anular problemas de resolución de nombres o variables de entorno.     *   **Launcher:** Se creó 'scripts/run_lan.ps1' para automatizar el arranque en modo red.     *   **Usuarios:** Se creó el usuario 'operador' (carga restringida) y se reseteó 'admin'.  ### Estado Final El sistema está desplegado en la red local y listo para que el equipo comience la carga y depuración de datos.

## SESIÓN 2025-12-17: Depuración de Persistencia y Alineación UX (Baja de Productos)

### Objetivos Alcanzados
1.  **Persistencia de Baja Lógica (Soft Delete)**: Se diagnosticó y corrigió un fallo crítico donde los productos "desactivados" reaparecían como activos tras el refresco.
    *   **Causa Raíz 1 (Backend)**: El endpoint `GET /productos/` devolvía un objeto debug incompleto sin el campo `activo`. Se restauró el `response_model=List[schemas.ProductoRead]` para garantizar integridad de datos.
    *   **Causa Raíz 2 (Infra)**: Configuración CORS incorrecta (Comodín `*` + Credenciales) bloqueaba peticiones PUT/POST en navegadores modernos. Se restringió a orígenes explícitos.
    *   **Causa Raíz 3 (SQLite)**: Fallos de concurrencia (`ConnectionReset`) al escribir en DB desde hilos paralelos. Se aplicó `check_same_thread=False` en `database.py`.
2.  **Alineación UX/UI**: Se rediseñó el inspector de productos para coincidir con el módulo de Clientes.
    *   Reemplazo de botón "toggle" genérico por botones explícitos: **"Dar de Baja"** (Rojo) y **"Activar"** (Verde).
    *   Lógica de refresco automático robusta en `ProductosView.vue` para reflejar cambios inmediatamente.
3.  **Limpieza de Datos**: Se verificó la capacidad operativa del "Limpiador de Productos" (Baja Masiva).
    *   Se eliminaron/desactivaron ítems obsoletos en la base `pilot.db`.

### Estado del Sistema
*   **Backend**: Estable (V10.16 Modular + Fixes de Seguridad/Concurrencia). Requiere reinicio final.
*   **Frontend**: Sincronizado. Navegación fluida y feedback visual correcto.
*   **Datos**: `pilot.db` parcialmente depurada.

### Próximos Pasos (OF - Mañana)
*   Continuar con la depuración masiva de productos obsoletos.
*   Verificar integración con reportes de stock (asegurar que inactivos no suman).

---
